<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authentication Integration Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .test-section {
      border: 1px solid #ccc;
      margin: 20px 0;
      padding: 15px;
      border-radius: 5px;
    }

    .test-section h3 {
      margin-top: 0;
      color: #333;
    }

    button {
      margin: 5px;
      padding: 8px 16px;
      cursor: pointer;
    }

    .success {
      background-color: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }

    .info {
      background-color: #d1ecf1;
      border-color: #bee5eb;
      color: #0c5460;
    }

    #event-log {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }

    #players-list {
      list-style: none;
      padding: 0;
    }

    #players-list li {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      margin: 5px 0;
      padding: 10px;
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <h1>Authentication Integration Test</h1>
  <p>This page tests the authentication event system and player list refresh functionality.</p>

  <div class="test-section">
    <h3>Authentication Events</h3>
    <button onclick="simulateAuthStateChange(true)">Simulate Auth Success</button>
    <button onclick="simulateAuthStateChange(false)">Simulate Auth Logout</button>
    <button onclick="simulateAuthSuccess()">Simulate Auth Success Event</button>
    <button onclick="simulateAuthRefresh()">Simulate Token Refresh</button>
    <button onclick="simulateNavigateToApp()">Simulate Navigate to App</button>
  </div>

  <div class="test-section">
    <h3>Player List</h3>
    <div>
      <input type="text" id="player-name" placeholder="Enter player name">
      <button onclick="addTestPlayer()">Add Player</button>
      <button onclick="clearPlayers()">Clear Players</button>
    </div>
    <ul id="players-list"></ul>
    <p>Player Count: <span id="player-count">0</span></p>
  </div>

  <div class="test-section">
    <h3>Event Log</h3>
    <button onclick="clearLog()">Clear Log</button>
    <div id="event-log"></div>
  </div>

  <script>
    // Mock localStorage for testing
    const mockStorage = {
      data: {},
      getItem: function (key) {
        return this.data[key] || null;
      },
      setItem: function (key, value) {
        this.data[key] = value;
      },
      removeItem: function (key) {
        delete this.data[key];
      },
      clear: function () {
        this.data = {};
      }
    };

    // Mock player data
    let players = [
      { id: '1', name: 'Test Player 1' },
      { id: '2', name: 'Test Player 2' }
    ];

    // Event logging
    function logEvent(message) {
      const log = document.getElementById('event-log');
      const timestamp = new Date().toLocaleTimeString();
      log.innerHTML += `[${timestamp}] ${message}\n`;
      log.scrollTop = log.scrollHeight;
    }

    // Mock authentication event handlers (simulating the player management component)
    function handleAuthStateChange(event) {
      const { isAuthenticated } = event.detail;
      logEvent(`Authentication state changed: ${isAuthenticated}`);

      if (isAuthenticated) {
        logEvent('Refreshing player list due to auth state change...');
        refreshPlayerList();
      }
    }

    function handleAuthSuccess(event) {
      logEvent('Authentication successful, refreshing player list');
      refreshPlayerList();
    }

    function handleAuthRefresh(event) {
      logEvent('Authentication refreshed, ensuring player list is current');
      refreshPlayerList();
    }

    function handleAuthLogout(event) {
      logEvent('User logged out, clearing player list');
      clearPlayerList();
    }

    function handleNavigatedToApp(event) {
      logEvent('Navigated to app, refreshing player list');
      refreshPlayerList();
    }

    // Player list management
    function refreshPlayerList() {
      logEvent('Refreshing player list...');

      setTimeout(() => {
        const playersList = document.getElementById('players-list');
        const playerCount = document.getElementById('player-count');

        // Clear current list
        playersList.innerHTML = '';

        // Add players
        players.forEach(player => {
          const li = document.createElement('li');
          li.textContent = player.name;
          playersList.appendChild(li);
        });

        // Update count
        playerCount.textContent = players.length;

        logEvent(`Player list refreshed: ${players.length} players loaded`);
      }, 100);
    }

    function clearPlayerList() {
      const playersList = document.getElementById('players-list');
      const playerCount = document.getElementById('player-count');

      playersList.innerHTML = '';
      playerCount.textContent = '0';

      logEvent('Player list cleared');
    }

    // Test functions
    function simulateAuthStateChange(isAuthenticated) {
      const event = new CustomEvent('authStateChanged', {
        detail: { isAuthenticated }
      });
      document.dispatchEvent(event);
    }

    function simulateAuthSuccess() {
      const event = new CustomEvent('authSuccess', {
        detail: { isAuthenticated: true }
      });
      document.dispatchEvent(event);
    }

    function simulateAuthRefresh() {
      const event = new CustomEvent('authRefreshed', {
        detail: { isAuthenticated: true }
      });
      document.dispatchEvent(event);
    }

    function simulateNavigateToApp() {
      const event = new CustomEvent('navigatedToApp', {
        detail: { isAuthenticated: true }
      });
      document.dispatchEvent(event);
    }

    function addTestPlayer() {
      const input = document.getElementById('player-name');
      const name = input.value.trim();

      if (name) {
        const newPlayer = {
          id: Date.now().toString(),
          name: name
        };
        players.push(newPlayer);
        input.value = '';

        logEvent(`Added player: ${name}`);
        refreshPlayerList();
      }
    }

    function clearPlayers() {
      players = [];
      logEvent('Cleared all players from storage');
      refreshPlayerList();
    }

    function clearLog() {
      document.getElementById('event-log').innerHTML = '';
    }

    // Set up event listeners (simulating what the player management component does)
    document.addEventListener('authStateChanged', handleAuthStateChange);
    document.addEventListener('authSuccess', handleAuthSuccess);
    document.addEventListener('authRefreshed', handleAuthRefresh);
    document.addEventListener('authLogout', handleAuthLogout);
    document.addEventListener('navigatedToApp', handleNavigatedToApp);

    // Initialize
    logEvent('Authentication integration test initialized');
    logEvent('Event listeners set up for: authStateChanged, authSuccess, authRefreshed, authLogout, navigatedToApp');
    refreshPlayerList();
  </script>
</body>

</html>