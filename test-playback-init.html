<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Playback Initialization</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }

    .success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .info {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
  </style>
</head>

<body>
  <h1>Playback System Initialization Test</h1>
  <p>This test verifies that the playback system is NOT initialized when the user is not authenticated.</p>

  <div id="test-results"></div>

  <button onclick="runTests()">Run Tests</button>
  <button onclick="simulateAuth()">Simulate Authentication</button>
  <button onclick="clearResults()">Clear Results</button>

  <script type="module">
    function addResult(message, type = 'info') {
      const resultsDiv = document.getElementById('test-results');
      const resultDiv = document.createElement('div');
      resultDiv.className = `test-result ${type}`;
      resultDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      resultsDiv.appendChild(resultDiv);
    }

    window.runTests = function () {
      addResult('Starting playback initialization tests...', 'info');

      // Test 1: Check if Spotify Web Playback SDK is loaded
      if (typeof window.Spotify !== 'undefined') {
        addResult('❌ FAIL: Spotify Web Playback SDK should not be loaded on page load', 'error');
      } else {
        addResult('✅ PASS: Spotify Web Playback SDK is not loaded (good)', 'success');
      }

      // Test 2: Check for playback-related error messages in console
      // This is a bit tricky to test directly, but we can check if certain elements exist
      const playbackElements = document.querySelectorAll('[id*="playback"], [class*="playback"]');
      if (playbackElements.length === 0) {
        addResult('✅ PASS: No playback-related DOM elements found', 'success');
      } else {
        addResult(`⚠️ WARNING: Found ${playbackElements.length} playback-related elements`, 'error');
      }

      // Test 3: Check localStorage for any authentication tokens
      const hasAuthToken = localStorage.getItem('spotify_access_token') ||
        document.cookie.includes('spotify_access_token');

      if (!hasAuthToken) {
        addResult('✅ PASS: No authentication tokens found (user not authenticated)', 'success');
      } else {
        addResult('⚠️ WARNING: Authentication tokens found - user may be authenticated', 'error');
      }

      addResult('Tests completed. If all tests pass, playback system is correctly NOT initialized.', 'info');
    };

    window.simulateAuth = function () {
      addResult('Simulating authentication...', 'info');

      // Dispatch authentication events to test the initialization
      const authEvent = new CustomEvent('authStateChanged', {
        detail: { isAuthenticated: true }
      });
      document.dispatchEvent(authEvent);

      const successEvent = new CustomEvent('authSuccess', {
        detail: { isAuthenticated: true }
      });
      document.dispatchEvent(successEvent);

      addResult('Authentication events dispatched. Check console for initialization messages.', 'info');
    };

    window.clearResults = function () {
      document.getElementById('test-results').innerHTML = '';
    };

    // Listen for authentication events to verify they work
    document.addEventListener('authStateChanged', (event) => {
      addResult(`Received authStateChanged event: ${event.detail.isAuthenticated}`, 'info');
    });

    document.addEventListener('authSuccess', (event) => {
      addResult('Received authSuccess event', 'info');
    });

    // Run tests automatically on load
    setTimeout(runTests, 1000);
  </script>
</body>

</html>